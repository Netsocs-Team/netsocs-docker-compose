services:
    # Database Services
    mongodb:
        container_name: netsocs-mongodb
        image: mongo:7.0
        restart: unless-stopped
        environment:
            - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USER:-root}
            - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-password}
            - MONGO_INITDB_DATABASE=${MONGO_DATABASE:-netsocs}
        volumes:
            - mongodb_data:/data/db
        ports:
            - "27017:27017"
        networks:
            - netsocs-network

    redis:
        container_name: netsocs-redis
        image: redis:7.2-alpine
        restart: unless-stopped
        command: redis-server --requirepass ${REDIS_PASS:-password}
        volumes:
            - redis_data:/data
        ports:
            - "6379:6379"
        networks:
            - netsocs-network

    mysql:
        container_name: netsocs-mysql
        image: mysql:8.0
        restart: unless-stopped
        environment:
            - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD:-rootpassword}
            - MYSQL_DATABASE=${DB_NAME:-netsocs}
            - MYSQL_USER=${DB_USER:-netsocs}
            - MYSQL_PASSWORD=${DB_PASS:-password}
        volumes:
            - mysql_data:/var/lib/mysql
            - ./mysql/init:/docker-entrypoint-initdb.d
        ports:
            - "3306:3306"
        networks:
            - netsocs-network

    # Application Services
    keycloak:
        container_name: keycloak-service
        image: ghcr.io/netsocs-team/service.kc/main:c5e69dd293ccac44f84cf85f9953381c98609df4
        environment:
            - KEYCLOAK_LOGLEVEL=ALL
            - KEYCLOAK_ADMIN=admin
            - KEYCLOAK_ADMIN_PASSWORD=admin123
            - KEYCLOAK_HTTP_PORT=8080
            - KEYCLOAK_HTTPS_PORT=8443
            - KC_DB=mysql
            - KC_DB_URL_DATABASE=${DB_NAME}
            - KC_PROXY=edge
            - KC_HOSTNAME=${HTTP_HOSTNAME}/auth
            - KC_DB_USERNAME=${DB_USER}
            - KC_DB_PASSWORD=${DB_PASS}
            - KC_DB_URL_HOST=${DB_HOST}
            - KC_DB_URL_PORT=${DB_PORT}
    dashboard_frontend:
        container_name: netsocs-modules-dashboard-frontend-service
        image: ghcr.io/netsocs-team/module.dashboard/frontend:dev
    dashboard_backend:
        container_name: netsocs-modules-dashboard-backend-service-v2
        image: ghcr.io/netsocs-team/module.dashboard/backendv2:dev
        environment:
            - PORT=3000
            - MYSQLDB_USER=${DB_USER}
            - MYSQLDB_PASSWORD=${DB_PASS}
            - MYSQLDB_HOST=${DB_HOST}
            - MYSQLDB_PORT=${DB_PORT}
            - MYSQLDB_DATABASE=${DB_NAME}
            - MYSQLDB_TABLE_PREFIX=dashboard_
            - DRIVERHUB_API_URL=http://netsocs-driverhub-service:3196
            - MONGODB_URI=${MONGO_URI}
            - MONGODB_DATABASE=${MONGO_DATABASE}
    configuration_frontend:
        container_name: netsocs-modules-configuration-frontend-service
        image: ghcr.io/netsocs-team/module.configuration/frontend:dev
    configuration_backend:
        container_name: netsocs-modules-configuration-backendv2-service
        image: ghcr.io/netsocs-team/module.configuration/backend_v2:dev
        environment:
            - PORT=3091
            - NAME_DB=${DB_NAME}
            - HOST_DB=${DB_HOST}
            - USER_DB=${DB_USER}
            - PASS_DB=${DB_PASS}
            - PORT_DB=${DB_PORT}
    automation:
        image: ghcr.io/netsocs-team/module.automation/backend:dev
        environment:
            - MYSQL_HOST=${DB_HOST}
            - MYSQL_USER=${DB_USER}
            - MYSQL_PASSWORD=${DB_PASS}
            - MYSQL_PORT=${DB_PORT}
            - MYSQL_DATABASE=${DB_NAME}
        container_name: automation-backend-service
    access_control_backend:
        container_name: netsocs-modules-accesscontrol-backend-service
        image: ghcr.io/netsocs-team/module.access_control/backend:main
        environment:
            - MYSQL_HOST=${DB_HOST}
            - MYSQL_USER=${DB_USER}
            - MYSQL_PASSWORD=${DB_PASS}
            - MYSQL_PORT=${DB_PORT}
            - TABLE_PREFIX=ac
            - MYSQL_DATABASE=${DB_NAME}
            - API_PORT=3000
            - ENABLE_CORS=true
            - MAIL_HOST=gator2120.hostgator.com
            - MAIL_PORT=465
            - MAIL_USERNAME=teresa.carreno@netsocs.com
            - MAIL_PASSWORD=p4ssword
            - DRIVERHUB_URL=http://netsocs-driverhub-service:3196
            - CONFIG_MODULE_API_V2_URL=http://netsocs-modules-configuration-backendv2-service:3091/api/v2
            - STATIC_FOLDER=static
    driverhub:
        container_name: netsocs-driverhub-service
        image: ghcr.io/netsocs-team/service.driver_hub/backend:dev
        environment:
            - REDIS_HOST=${REDIS_HOST}
            - REDIS_PORT=${REDIS_PORT}
            - REDIS_PASSWORD=${REDIS_PASS}
            - STATIC_FOLDER=/app/static
            - MYSQL_DATABASE=${DB_NAME}
            - MYSQL_USER=${DB_USER}
            - MYSQL_PASSWORD=${DB_PASS}
            - MYSQL_HOST=${DB_HOST}
            - MYSQL_PORT=${DB_PORT}
            - MONGODB_URI=${MONGO_URI}
            - MEDIAMTX_DEFAULT_HOSTNAME=${MEDIAMTX_HOSTNAME}

# Volumes for persistent data
volumes:
    mongodb_data:
        driver: local
    redis_data:
        driver: local
    mysql_data:
        driver: local

# Networks for service communication
networks:
    netsocs-network:
        driver: bridge
